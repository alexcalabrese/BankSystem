<head>
  <title>Transfer</title>
  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link
    type="text/css"
    rel="stylesheet"
    href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css"
  />
  <link
    type="text/css"
    rel="stylesheet"
    href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css"
  />

  <!-- CSS only -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
    crossorigin="anonymous"
  />

  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://unpkg.com/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
  {% comment %}
  <script type="text/javascript">
    window.CSRF_TOKEN = "{{ csrf_token }}";
  </script>
  {% endcomment %}
</head>

<div id="app">
  <div>
    <b-navbar toggleable="lg" type="dark" variant="dark">
      <b-navbar-brand class="m-2" href="{% url 'homepage' %}"
        >Bank</b-navbar-brand
      >

      <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

      <b-collapse id="nav-collapse" is-nav>
        <b-navbar-nav align="center" class="justify-content-center">
          <b-nav-item href="{% url 'transfer_page' %}"
            >Transfer Money</b-nav-item
          >
          <b-nav-item href="#"> Insert another user</b-nav-item>
        </b-navbar-nav>
      </b-collapse>
    </b-navbar>
  </div>
  <b-container class="m-3" fluid>
    <b-row class="my-1">
      <b-col sm="5">
        <h2>New Transaction</h2>

        <b-form-group
          label="From:"
          label-for="nested-city"
          label-cols-sm="3"
          label-align-sm="right"
        >
          <b-form-input v-model="transaction.account_from"></b-form-input>
        </b-form-group>

        <b-form-group
          label="To:"
          label-for="nested-city"
          label-cols-sm="3"
          label-align-sm="right"
        >
          <b-form-input v-model="transaction.account_to"></b-form-input>
        </b-form-group>

        <b-form-group
          label="Amount:"
          label-for="nested-city"
          label-cols-sm="3"
          label-align-sm="right"
        >
          <b-form-input v-model="transaction.amount"></b-form-input>
        </b-form-group>
        <!-- This will only be shown if the preceding input has an invalid state -->
        <b-form-invalid-feedback id="input-live-feedback">
          Account id is not valid
        </b-form-invalid-feedback>
        <b-alert class="mt-3" variant="success" :show="transactionSuccess"
          >Transaction created with success!</b-alert
        >
        <b-alert class="mt-3" variant="danger" :show="transactionError.show">
          {{ transactionError.message }}
          <br />
          {{ transactionError.current_balance != null ?
          transactionError.current_balance : "" }}
        </b-alert>
        <b-button
          class="mt-2"
          @click="sendTransaction()"
          variant="outline-primary"
          >Send</b-button
        >
      </b-col>
    </b-row>
    <!-- <hr class="solid" /> -->
  </b-container>
</div>

<style>
  table {
    font-family: Arial, sans-serif;
    border-collapse: collapse;
    width: 100%;
  }

  td,
  th {
    border: 2px solid #dddddddd;
    text-align: left;
    padding: 4px;
  }
</style>

{% csrf_token %}
<script>
  const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  new Vue({
    data() {
      return {
        transaction: {
          account_from: null,
          account_to: null,
          amount: null,
        },
        transactionSuccess: false,
        transactionError: {
          show: false,
          message: null,
          current_balance: null,
        },
      };
    },
    methods: {
      sendTransaction() {
        console.log(JSON.stringify(this.transaction));
        // if (this.validateId(this.accountId)) {
        let url = "http://127.0.0.1:8000/api/transfer";
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify(this.transaction),
        })
          .then((response) => {
            if (!response.ok) {
              // throw Error(response.statusText);
              return Promise.reject(response);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Success:", data);
            this.transactionSuccess = true;
          })
          .catch((error) => {
            // console.error(error);
            error.json().then((json) => {
              console.log(json.hasOwnProperty("current_balance"));
              this.transactionError.message = json.message;
              if (json.hasOwnProperty("current_balance")) {
                this.transactionError.current_balance =
                  "Sender balance: " + json.current_balance;
              }
              this.transactionError.show = true;
            });
          });
      },
      isObject(o) {
        return (
          o !== null && typeof o === "object" && Array.isArray(o) === false
        );
      },
    },
    validateId(accountId) {
      let re = /[0-9A-Fa-f]{20}/g;
      if (accountId.length == 20 && re.test(accountId)) {
        this.inputState = true;
        return true;
      } else {
        this.inputState = false;
        return false;
      }
    },
  }).$mount("#app");
</script>
